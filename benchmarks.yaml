version: 1

thresholds:
  min_precision_at_k: 0.45
  min_coverage: 0.8
  max_p95_latency_ms: 320
  min_refinement_hit_rate: 0.2

regression:
  max_precision_drop: 0.03
  max_coverage_drop: 0.05
  max_latency_increase_ms: 40
  max_refinement_hit_rate_drop: 0.2

sources:
  - source_name: email
    source_class: personal
    supported_methods: [structured, fulltext, vector]
    supported_filters:
      - name: from_name
        type: string
        operators: [contains]
      - name: date_after
        type: date
        operators: [gte]
    alias_hints: [gmail, inbox, email]
    freshness_window_days: 30
    latency_tier: medium
    quality_tier: high
    cost_tier: medium

  - source_name: calendar
    source_class: personal
    supported_methods: [structured, fulltext]
    supported_filters:
      - name: date_after
        type: date
        operators: [gte]
    alias_hints: [calendar, meeting]
    freshness_window_days: 2
    latency_tier: low
    quality_tier: high
    cost_tier: low

  - source_name: web
    source_class: web
    supported_methods: [fulltext, vector]
    supported_filters: []
    alias_hints: [web, internet]
    freshness_window_days: 7
    latency_tier: high
    quality_tier: medium
    cost_tier: high

cases:
  - id: sender_email_lookup
    query: "emails from Sarah about budget"
    expected_sources: [email]
    expected_relevance:
      top_k: 1
      relevant:
        - source: email
          title_contains: [budget, sarah]
    thresholds:
      min_precision_at_k: 1.0
      min_coverage: 1.0
      max_latency_ms: 250
      expect_refinement: false
    mock_results:
      email:
        latency_ms: 80
        items:
          - id: em_001
            title: "Budget review from Sarah"
            snippet: "Sarah sent the updated Q2 budget sheet"
            scores: {structured: 0.93, fulltext: 0.84}
            methods_used: [structured, fulltext]
            metadata: {from: "Sarah <sarah@example.com>"}
          - id: em_002
            title: "Budget follow-up from Sarah"
            snippet: "Action items and final numbers"
            scores: {fulltext: 0.74}
            methods_used: [fulltext]
            metadata: {from: "Sarah <sarah@example.com>"}
          - id: em_003
            title: "Budget approvals"
            snippet: "Approved by finance"
            scores: {vector: 0.62}
            methods_used: [vector]
            metadata: {from: "finance@example.com"}

  - id: cross_source_status
    query: "find project phoenix updates from email and web"
    expected_sources: [email, web]
    expected_relevance:
      top_k: 4
      relevant:
        - source: email
          title_contains: [phoenix]
        - source: web
          title_contains: [phoenix]
    thresholds:
      min_precision_at_k: 0.5
      min_coverage: 1.0
      max_latency_ms: 320
      expect_refinement: true
    mock_results:
      email:
        latency_ms: 90
        items:
          - id: em_004
            title: "Phoenix migration complete"
            snippet: "Internal status update from engineering"
            scores: {fulltext: 0.81, vector: 0.74}
            methods_used: [fulltext, vector]
            metadata: {from: "ops@example.com"}
      web:
        latency_ms: 160
        items:
          - id: web_007
            title: "Phoenix framework release notes"
            snippet: "Public roadmap and bugfix notes"
            scores: {fulltext: 0.69, vector: 0.66}
            methods_used: [fulltext, vector]
            metadata: {domain: "example.dev"}
          - id: web_008
            title: "Phoenix postmortem"
            snippet: "Incident review and lessons learned"
            scores: {vector: 0.59}
            methods_used: [vector]
            metadata: {domain: "example.dev"}

  - id: temporal_calendar
    query: "what meetings happened today"
    expected_sources: [calendar]
    expected_relevance:
      top_k: 1
      relevant:
        - source: calendar
          title_contains: [meeting]
    thresholds:
      min_precision_at_k: 0.33
      min_coverage: 1.0
      max_latency_ms: 220
      expect_refinement: false
    mock_results:
      calendar:
        latency_ms: 60
        items:
          - id: cal_002
            title: "Meeting with design"
            snippet: "Discussed launch criteria"
            scores: {structured: 0.95}
            methods_used: [structured]
            metadata: {calendar_id: "primary"}
          - id: cal_003
            title: "Meeting: launch readiness"
            snippet: "Checklist review"
            scores: {structured: 0.88}
            methods_used: [structured]
            metadata: {calendar_id: "primary"}
          - id: cal_004
            title: "Meeting with support"
            snippet: "Issue triage"
            scores: {fulltext: 0.76}
            methods_used: [fulltext]
            metadata: {calendar_id: "primary"}

  - id: sparse_query_triggers_refine
    query: "show quick email notes about roadmap"
    expected_sources: [email]
    expected_relevance:
      top_k: 3
      relevant:
        - source: email
          title_contains: [roadmap]
    thresholds:
      min_precision_at_k: 0.33
      min_coverage: 1.0
      max_latency_ms: 260
      expect_refinement: true
    mock_results:
      email:
        latency_ms: 110
        items:
          - id: em_009
            title: "Roadmap notes"
            snippet: "Short notes"
            scores: {vector: 0.41}
            methods_used: [vector]
            metadata: {from: "pm@example.com"}

  - id: no_results_with_filters
    query: "calendar events today from alice"
    expected_sources: [calendar]
    expected_relevance:
      top_k: 3
      relevant: []
    thresholds:
      min_precision_at_k: 0.0
      min_coverage: 0.0
      max_latency_ms: 180
      expect_refinement: false
    mock_results:
      calendar:
        latency_ms: 70
        items: []
